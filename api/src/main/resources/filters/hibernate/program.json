[
    {
        "name": "datafilter_programBasedUserFilter",
        "targetClasses": [
            "org.openmrs.User"
        ],

        /*
        Goals:
            1- Include users that work in at least one program as the authenticated user
            2- Include users that don't work in any program
            4- Include users that have zero roles or privileges
            3- Otherwise exclude the rest

        Assumptions:
            1- filters are applied where there is an authenticated user

        Parameters:
            userProgramPrivileges: The collection of all of the authenticated user's program privileges
            allProgramPrivileges: The collection of all program privileges in the system

        */
        "condition": "(
            user_id IN (
                SELECT DISTINCT ur.user_id FROM user_role ur
                    WHERE ur.role IN (SELECT DISTINCT rp.role FROM role_privilege rp WHERE rp.privilege IN (:userProgramPrivileges))
                    OR ur.role NOT IN (SELECT DISTINCT rp.role FROM role_privilege rp WHERE rp.privilege IN (:allProgramPrivileges))
            ) OR user_id NOT IN (SELECT DISTINCT ur2.user_id FROM user_role ur2)
        )",
        "parameters": [
            {
                "name": "userProgramPrivileges",
                "type": "string"
            },
            {
                "name": "allProgramPrivileges",
                "type": "string"
            }
        ]
    },
    {
        "name": "datafilter_programBasedProviderFilter",
        "targetClasses": [
            "org.openmrs.Provider"
        ],

        /*
         * See the goals, assumptions and condition logic for user filter above, applies for providers too
         * for persons with a user account. For providers that are not linked to a person record but have no
         * provider role or they have a provider role linked to the same program, they will be visible
         */
        "condition": "(
            person_id IN (
                SELECT us.person_id FROM users us
                    WHERE us.user_id IN (
                        SELECT DISTINCT ur.user_id FROM user_role ur
                            WHERE ur.role IN (SELECT DISTINCT rp.role FROM role_privilege rp WHERE rp.privilege IN (:userProgramPrivileges))
                            OR ur.role NOT IN (SELECT DISTINCT rp.role FROM role_privilege rp WHERE rp.privilege IN (:allProgramPrivileges))
                    )
                    OR us.user_id NOT IN (SELECT DISTINCT ur2.user_id FROM user_role ur2)
            )
            OR (person_id IS NULL AND provider_id IN (
                SELECT DISTINCT pr.provider_id FROM provider pr
                    WHERE pr.role_id IS NULL OR pr.role_id IN (
                        SELECT DISTINCT dfebm.entity_identifier FROM datafilter_entity_basis_map dfebm
                            WHERE dfebm.entity_type = 'org.openmrs.Concept'
                            AND dfebm.basis_type = 'org.openmrs.Program'
                            AND dfebm.basis_identifier IN (
                                SELECT DISTINCT dfebm1.basis_identifier FROM datafilter_entity_basis_map dfebm1
                                    WHERE dfebm1.basis_type = 'org.openmrs.Program'
                                    AND dfebm1.entity_type = 'org.openmrs.Privilege'
                                    AND dfebm1.entity_identifier IN (
                                        SELECT DISTINCT rp1.privilege FROM role_privilege rp1 WHERE rp1.role IN (:userProgramRoleNames)
                                    )
                                )
                            )
                    OR pr.role_id NOT IN (
                        SELECT DISTINCT dfebm2.entity_identifier FROM datafilter_entity_basis_map dfebm2
                            WHERE dfebm2.entity_type = 'org.openmrs.Concept'
                            AND dfebm2.basis_type = 'org.openmrs.Program')
                )
            )
        )",
        "parameters": [
            {
                "name": "userProgramPrivileges",
                "type": "string"
            },
            {
                "name": "allProgramPrivileges",
                "type": "string"
            },
            {
                "name": "userProgramRoleNames",
                "type": "string"
            }
        ]
    }
]
